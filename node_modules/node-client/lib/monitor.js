/**
 * Created by hetiu on 2017/6/13.
 */
const prom = require('prom-client');
const http = require('http');

const ENABLE_MONITOR = (process.env.ENABLE_MONITOR === 'true');
const MONITOR_PORT = process.env.MONITOR_PORT || '9092';
// const MONITOR_PATH = process.env.MONITOR_PATH || '/metrics';
const MONITOR_DEFAULT_INTERVAL = parseInt(process.env.MONITOR_DEFAULT_INTERVAL, 10);

if (ENABLE_MONITOR) {
    const server = http.createServer((req, res) => {
        res.writeHead(200, {'content-type': prom.register.contentType});
        res.end(prom.register.metrics())
    });

    server.listen(MONITOR_PORT, () => {
        console.log('monitor exporter listening at %s', MONITOR_PORT);
    });

    // 监控nodejs的cpu/mem
    if (MONITOR_DEFAULT_INTERVAL) {
        prom.collectDefaultMetrics(MONITOR_DEFAULT_INTERVAL * 1000);
    }
}

module.exports.isEnable = ENABLE_MONITOR;